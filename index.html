<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rifa Solidária - Loja Fraternidade de Aracati Nº4789</title>
<style>
:root {
  --primary: #4a90e2;
  --secondary: #f2f6fc;
  --success: #a8e6cf;
  --success-border: #56c596;
  --card-bg: #ffffff;
  --text-light: #555;
  --text-dark: #222;
  --btn-bg: #4a90e2;
  --btn-hover: #357ab7;
}

body {
  margin: 0;
  padding: 20px;
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  background: var(--secondary);
  color: var(--text-dark);
  display: flex;
  justify-content: center;
}

.container {
  max-width: 700px;
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

header {
  text-align: center;
}

header h1 {
  font-size: 26px;
  margin-bottom: 15px;
  color: var(--primary);
}

.controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
}

select, button {
  padding: 10px 16px;
  border-radius: 8px;
  border: 1px solid #cfd5e6;
  font-size: 16px;
  cursor: pointer;
}

button {
  background: var(--btn-bg);
  color: #fff;
  border: none;
  transition: 0.2s;
}

button:hover { background: var(--btn-hover); }

.card {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 20px;
}

.numbers {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-top: 15px;
  max-height: 500px;
  overflow-y: auto;
  padding-right: 6px;
}

.num {
  padding: 15px 0;
  font-size: 18px;
  text-align: center;
  border-radius: 8px;
  border: 1px solid #d9dce6;
  background: #f9faff;
  cursor: pointer;
  user-select: none;
  transition: 0.2s;
}

.num:hover { background: #e1eaff; }
.num.sold { background: var(--success); border-color: var(--success-border); text-decoration: line-through; }

.meta {
  font-size: 14px;
  color: var(--text-light);
  margin-top: 10px;
}

.footer-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.export-area {
  white-space: pre-wrap;
  background: #f0f4ff;
  padding: 10px;
  border-radius: 8px;
  margin-top: 12px;
  font-family: monospace;
  font-size: 14px;
  border: 1px solid #cfd5e6;
}

@media(max-width:600px){
  .numbers { grid-template-columns: repeat(3, 1fr); }
  select, button { font-size: 14px; padding: 8px 12px; }
  .num { font-size: 20px; padding: 18px 0; }
}
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Rifa Solidária — Loja Fraternidade de Aracati Nº4789</h1>
    <div class="controls">
      <label>Irmão:</label>
      <select id="brotherSelect"></select>
      <button id="btnExport">Exportar CSV</button>
    </div>
  </header>

  <section class="card">
    <strong>Atribuição de números (25 cada)</strong>
    <div id="assignmentList" class="meta"></div>

    <div class="meta" style="margin-top:10px;">Números do irmão selecionado:</div>
    <div id="numbers" class="numbers"></div>

    <div class="meta" id="summary"></div>

    <div class="footer-actions">
      <button id="btnMarkAll">Marcar todos</button>
      <button id="btnUnmarkAll">Desmarcar todos</button>
    </div>

    <div id="exportArea" class="export-area"></div>
  </section>

  <section class="card">
    <strong>Resumo geral</strong>
    <div id="totals" style="margin-top:8px;"></div>
  </section>
</div>

<script>
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbxsY2oD_4Y8OrxrYosn3RGz7bzs_7KcbiH0CluHmqxYyZj8pA61Aq8BePRCxCVvznG_/exec';
const CSV_PASSWORD = '12345610';

const brothers = [
  'Renato Carlos VM','Cicero Pessoa MI','Robson Porto MM','José Amauri MI','Moesio Carvalho AP',
  'Yuri Emmanuel CM','Renê Carlos AP','Luis Gabriel AP','Francisco Josemar MM','José Hildo MM',
  'Georgiano MM','Rafael Barbosa MI','Neidio Bezerra MI','Julio Dantas AP','Rogério Carvalho AP',
  'Alexandre Castelo MI','Geremias Andrade MM','Ikaro Pessoa MM','João Filho MI','Marcus Vinicius MM'
];

const containerNumbers = document.getElementById('numbers');
const sel = document.getElementById('brotherSelect');
const summary = document.getElementById('summary');
const totals = document.getElementById('totals');
const exportArea = document.getElementById('exportArea');
const assignmentList = document.getElementById('assignmentList');

let data = []; 

// Inicializa select
brothers.forEach(b=>{
  const opt = document.createElement('option'); opt.value=b; opt.textContent=b; sel.appendChild(opt);
});

// Carrega dados da planilha
async function loadData() {
  try {
    const res = await fetch(WEBAPP_URL);
    data = await res.json();
    renderForSelected();
    renderTotals();
  } catch(e){ console.error(e); }
}

// Renderiza números do irmão
function renderForSelected(){
  const irmao = sel.value;
  const myNumbers = data.filter(d=>d.irmao===irmao);
  containerNumbers.innerHTML='';
  myNumbers.forEach(d=>{
    const el = document.createElement('div');
    el.className='num'+(d.status==='Sim'?' sold':'');
    el.textContent=d.numero;
    el.onclick = ()=> toggleNumber(d.numero, d);
    containerNumbers.appendChild(el);
  });
  summary.textContent=`Vendidos por ${irmao}: ${myNumbers.filter(d=>d.status==='Sim').length} / ${myNumbers.length}`;
  assignmentList.textContent = `Total números do irmão: ${myNumbers.length}`;
}

// Marca/desmarca número e envia
async function toggleNumber(numero, obj){
  const status = obj.status==='Sim'?'Não':'Sim';
  const comprador = status==='Sim'?prompt("Nome do comprador:","")||"":"";  
  obj.status = status;
  obj.comprador = comprador;
  try {
    await fetch(WEBAPP_URL,{
      method:'POST',
      body: JSON.stringify({numero,status,comprador}),
      headers:{'Content-Type':'application/json'}
    });
    renderForSelected();
    renderTotals();
  } catch(e){ console.error(e); }
}

// Marcar/desmarcar todos
function markAll(){ const irmao=sel.value; data.filter(d=>d.irmao===irmao && d.status!=='Sim').forEach(d=>toggleNumber(d.numero,d)); }
function unmarkAll(){ const irmao=sel.value; data.filter(d=>d.irmao===irmao && d.status==='Sim').forEach(d=>toggleNumber(d.numero,d)); }

// Exportar CSV
function exportCSV(){
  const senha = prompt("Digite a senha para exportar CSV:");
  if(senha!==CSV_PASSWORD){ alert("Senha incorreta!"); return; }
  let rows = ['Numero;Status;Irmão;Comprador'];
  data.forEach(d=>rows.push(`${d.numero};${d.status};${d.irmao};${d.comprador}`));
  const csv = rows.join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='rifa_vendas.csv'; a.click(); URL.revokeObjectURL(url);
  exportArea.textContent = csv;
}

// Renderiza resumo geral
function renderTotals(){
  let html = '';
  const totalsByBrother = {};
  data.forEach(d=>{
    if(!totalsByBrother[d.irmao]) totalsByBrother[d.irmao]=0;
    if(d.status==='Sim') totalsByBrother[d.irmao]++;
  });
  const totalVendas = Object.values(totalsByBrother).reduce((a,b)=>a+b,0);
  html+=`<div>Total vendidos: ${totalVendas} / ${data.length}</div>`;
  for(const b of brothers){ html+=`<div class="meta">${b}: ${totalsByBrother[b]||0}</div>`; }
  totals.innerHTML=html;
}

// Eventos
sel.addEventListener('change', renderForSelected);
document.getElementById('btnMarkAll').addEventListener('click', markAll);
document.getElementById('btnUnmarkAll').addEventListener('click', unmarkAll);
document.getElementById('btnExport').addEventListener('click', exportCSV);

// Atualização a cada 5 segundos
setInterval(loadData,5000);

// Inicializa
loadData();
</script>
</body>
</html>
